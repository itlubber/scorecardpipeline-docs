

<!DOCTYPE html>
<html class="no-js" lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="docsearch:name" content="scorecardpipeline" />
    <meta name="docsearch:package_type" content="" />
    <meta name="docsearch:release" content="0.1.38.02" />
    <meta name="docsearch:version" content="" />
    
      <title>scorecardpipeline.model &mdash; scorecardpipeline 0.1.38.02 文档</title>
    
    <link rel="stylesheet" href="../../_static/bootstrap-icons.css" type="text/css" />
          <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
          <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
          <link id="pygments_dark_css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css" href="../../_static/pygments_dark.css" />
          <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
          <link rel="stylesheet" type="text/css" href="../../_static/colorsets/sphinx-nefertiti-indigo.min.css" />
          <link rel="stylesheet" type="text/css" href="../../_static/fonts/nunito/stylesheet.css" />
          <link rel="stylesheet" type="text/css" href="../../_static/fonts/red-hat-mono/stylesheet.css" />
          <link rel="stylesheet" type="text/css" href="../../_static/fonts/nunito/stylesheet.css" />
          <link rel="stylesheet" type="text/css" href="../../_static/fonts/nunito/stylesheet.css" />
          <link rel="stylesheet" type="text/css" href="../../_static/fonts/nunito/stylesheet.css" />
          <link rel="stylesheet" type="text/css" href="../../_static/pygments_dark.css" />
        <link rel="index" title="索引" href="../../genindex.html" />
        <link rel="search" title="搜索" href="../../search.html" />
        <link rel="top" title="scorecardpipeline 0.1.38.02 文档" href="#" />
        <link rel="up" title="模块代码" href="../index.html" />
    <style>
      :root {
        --nftt-body-font-family: "Nunito", var(--nftt-font-sans-serif) !important;
        --nftt-font-monospace: "Red Hat Mono", var(--nftt-font-family-monospace) !important;
        --nftt-project-name-font: "Nunito", var(--nftt-body-font-family);
        --nftt-documentation-font: "Nunito", var(--nftt-body-font-family);
        --nftt-doc-headers-font: "Nunito", var(--nftt-documentation-font);}
      h1 *, h2 *, h3 *, h4 *, h5 *, h6 * { font-size: inherit; }
    </style>
  </head>
  <body>
    <header class="navbar navbar-expand-lg navbar-dark nftt-navbar flex-column fixed-top">
      <div class="skip-links container-xxl visually-hidden-focusable overflow-hidden justify-content-start">
        <div class="border-bottom mb-2 pb-2 w-100">
          <a class="d-none d-md-inline-flex p-2 m-1" href="#sidebar-filter">Skip to docs navigation</a>
          <a class="d-inline-flex p-2 m-1" href="#content">Skip to main content</a>
        </div>
      </div>
      <nav class="container-xxl nftt-gutter flex-wrap flex-lg-nowrap" aria-label="Main navigation">
        <div class="nftt-navbar-toggler">
          <button class="navbar-toggler p-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar" aria-label="Toggle documentation navigation">
            <i class="bi bi-list"></i>
          </button>
        </div>
          <a href="../../index.html"
              
              class="navbar-brand p-0 me-0 md-lg-2"
          ><span class="brand-text">scorecardpipeline</span></a>
        
        <div class="d-flex d-lg-none">
          <button class="navbar-toggler p-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#nfttSearch" aria-controls="nfttSearch" aria-label="Search">
            <i class="bi bi-search"></i>
          </button>
          <button class="navbar-toggler p-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#nfttNavbar" aria-controls="nfttNavbar" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
        </div>
        
<div class="offcanvas-lg offcanvas-end flex-grow-1" tabindex="-1" id="nfttSearch" aria-labelledby="nfttSearchOffcanvasLabel" data-bs-scroll="true">
  <div class="offcanvas-header px-4 pb-0">
    <h5 class="offcanvas-title fw-bold" id="nfttSearchOffcanvasLabel">Search the documentation</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#nfttSearch"></button>
  </div>
  <div class="offcanvas-body p-4 pt-0 p-lg-0 px-lg-3">
    <hr class="d-lg-none text-white-50">
    <ul class="navbar-nav flex-row align-items-center flex-wrap ms-md-auto">
      <li class="nav-item col-12 col-lg-auto">
        <form id="nftt-search-form" action="../../search.html" method="get">
          <div class="input-group">
            <input type="text" name="q" class="form-control" placeholder="Search docs" aria-label="Search" aria-describedby="button-search">
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
            <button class="btn btn-primary" type="submit" id="button-search" aria-label="Search"><i class="bi bi-search"></i></button>
          </div>
        </form>
      </li>
    </ul>
  </div>
</div>

        <div class="offcanvas-lg offcanvas-end" tabindex="-1" id="nfttNavbar" aria-labelledby="nfttNavbarOffcanvasLabel" data-bs-scroll="true">
          <div class="offcanvas-header px-4 pb-0">
            <div class="offcanvas-title text-white fw-bold" id="nfttNavbarOffcanvasLabel"><span class="brand-text">Nefertiti for Sphinx</span></div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#nfttNavbar"></button>
          </div>
          <div class="offcanvas-body p-4 pt-0 p-lg-0">
            <hr class="d-lg-none text-white-50">
            <ul class="navbar-nav flex-row align-items-center flex-wrap ms-md-auto">
              
              <li class="nav-item col-12 col-lg-auto">
                <a class="nav-link py-2 py-lg-0 px-0 px-lg-2" href="https://github.com/itlubber/scorecardpipeline" target="_blank" rel="noopener">
                  <div class="d-flex align-items-center">
                    <div class="me-2">
                      <i class="bi bi-git size-24"></i>
                    </div>
                    <div class="repo d-flex flex-column align-items-center" data-snftt-repo-url="https://github.com/itlubber/scorecardpipeline">
                      itlubber/scorecardpipeline
                      <div class="d-flex justify-content-center" data-snftt-repo-metrics>
                        <span class="pe-2 d-flex justify-content-center align-items-center">
                          <i class="bi bi-tag size-14"></i>
                          <span class="repo-metric" data-snftt-repo-tag></span>
                        </span>
                        <span class="pe-2 d-flex justify-content-center align-items-center">
                          <i class="bi bi-star size-14"></i>
                          <span class="repo-metric" data-snftt-repo-stars></span>
                        </span>
                        <span class="d-flex justify-content-center align-items-center">
                          <i class="bi bi-diagram-2 size-14"></i>
                          <span class="repo-metric" data-snftt-repo-forks></span>
                        </span>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              <li class="nav-item col-12 col-lg-auto h-100" aria-hidden="true">
                <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-white"></div>
                <hr class="d-lg-none text-white-50">
              </li>
              
              <!-- version_dropdown.html -->

  
    <li class="nav-item dropdown">
      <a class="nav-link d-flex py-2 px-0 px-lg-2 dropdown-toggle align-items-center" id="snftt-version" href="#" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Select version">
        <span id="snftt-version-text" class="d-lg-none small">scorecardpipeline</span>
        <span class="small ms-2" data-snftt-version-active="v0.1.38.02">v0.1.38.02</span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="snftt-version-text">
        <li>
          <h6 class="dropdown-header">Versions</h6>
        </li>
        
          <li>
            <a class="dropdown-item d-flex align-items-center justify-content-between" aria-pressed="false" href="https://itlubber.github.io/scorecardpipeline-docs" data-snftt-version-url="https://itlubber.github.io/scorecardpipeline-docs" data-snftt-version="v0.1.38.02">
              <span class="small ms-2">v0.1.38.02</span>
              <i class="bi bi-check ms-auto"></i>
            </a>
          </li>
        
      </ul>
    </li>
  

  <li class="nav-item col-12 col-lg-auto h-100" aria-hidden="true">
    <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-white"></div>
    <hr class="d-lg-none text-white-50">
  </li>

              
              <!-- colorscheme_dropdown.html -->
<li class="nav-item dropdown">
  <a class="nav-link d-flex py-2 px-0 px-lg-2 dropdown-toggle align-items-center" id="snftt-luz" href="#" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false" aria-label="Toggle light/dark">
    <i class="bi bi-circle-half" data-snftt-luz-icon-active></i>
    <span id="snftt-luz-text" class="d-lg-none small ms-2">Toggle light/dark</span>
  </a>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="snftt-luz-text">
    <li>
      <h6 class="dropdown-header">Light/dark</h6>
    </li>
    <li>
      <a class="dropdown-item d-flex align-items-center" data-snftt-luz="light" href="#" aria-pressed="false">
        <span class="small">
          <i class="bi bi-sun" data-snftt-luz-icon="light"></i>
        </span>
        <span class="small ms-3">Light</span>
        <i class="bi bi-check ms-auto"></i>
      </a>
    </li>
    <li>
      <a class="dropdown-item d-flex align-items-center" data-snftt-luz="dark" href="#" aria-pressed="false">
        <span class="small">
          <i class="bi bi-moon-stars" data-snftt-luz-icon="dark"></i>
        </span>
        <span class="small ms-3">Dark</span>
        <i class="bi bi-check ms-auto"></i>
      </a>
    </li>
    <li>
      <a class="dropdown-item current d-flex align-items-center" data-snftt-luz="default" href="#" aria-pressed="false">
        <span class="small">
          <i class="bi bi-circle-half" data-snftt-luz-icon="default"></i>
        </span>
        <span class="small ms-3">Default</span>
        <i class="bi bi-check ms-auto"></i>
      </a>
    </li>
  </ul>
</li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <div class="container-xxl nftt-gutter nftt-layout">
      <aside class="nftt-sidebar">
        <div class="title d-none d-md-block">
          <i class="bi bi-book"></i>&nbsp;&nbsp;<span>Table of contents</span>
        </div>
        <div id="sidebar" tabindex="-1" class="offcanvas-lg offcanvas-start" aria-labelledby="nfttSidebarOffcanvasLabel">
            <!-- danirus sidebartemplate: "globaltoc.html" --><div class="offcanvas-header border-bottom">
  <h5 class="offcanvas-title" id="nfttSidebarOffcanvasLabel">
    Table of contents
  </h5>
  <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#sidebar"></button>
</div>

<div class="offcanvas-body">
  <nav class="toc" aria-label="Main menu">
    <div class="mb-3 p-1 pt-3 pb-4 border-bottom">
      <input id="sidebar-filter" type="text" name="filter" class="form-control form-control-sm" placeholder="filter" aria-label="filter">
    </div>
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html#id2">版本说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html#id3">环境安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html#id4">使用示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html#id16">交流</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../scorecardpipeline.html">scorecardpipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scorecardpipeline.html#module-scorecardpipeline.processing">scorecardpipeline.processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scorecardpipeline.html#module-scorecardpipeline.feature_selection">scorecardpipeline.feature_selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scorecardpipeline.html#module-scorecardpipeline.model">scorecardpipeline.model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scorecardpipeline.html#module-scorecardpipeline.auto_eda">scorecardpipeline.auto_eda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scorecardpipeline.html#module-scorecardpipeline.auto_report">scorecardpipeline.auto_report</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scorecardpipeline.html#module-scorecardpipeline.utils">scorecardpipeline.utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scorecardpipeline.html#module-scorecardpipeline.excel_writer">scorecardpipeline.excel_writer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scorecardpipeline.html#module-scorecardpipeline.rule">scorecardpipeline.rule</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scorecardpipeline.html#module-scorecardpipeline.rule_extraction">scorecardpipeline.rule_extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scorecardpipeline.html#module-scorecardpipeline.logger">scorecardpipeline.logger</a></li>
</ul>

  </nav>
  <template data-toggle-item-template>
    <button class="btn btn-sm btn-link toctree-expand" type="button">
      <i class="bi bi-caret-right"></i>
      <span class="visually-hidden">Toggle menu contents</span>
    </button>
  </template>
</div>
        </div>
      </aside>
      <main class="nftt-main">
        <article id="content" class="nftt-content" role="main">
    <h1>scorecardpipeline.model 源代码</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@Time    : 2023/05/21 16:23</span>
<span class="sd">@Author  : itlubber</span>
<span class="sd">@Site    : itlubber.art</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scorecardpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">toad</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span>
<span class="kn">from</span> <span class="nn">sklearn.utils._array_api</span> <span class="kn">import</span> <span class="n">get_namespace</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.extmath</span> <span class="kn">import</span> <span class="n">safe_sparse_dot</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.validation</span> <span class="kn">import</span> <span class="n">check_is_fitted</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">,</span> <span class="n">ClassifierMixin</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.processing</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="ITLubberLogisticRegression"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ITLubberLogisticRegression">[文档]</a><span class="k">class</span> <span class="nc">ITLubberLogisticRegression</span><span class="p">(</span><span class="n">LogisticRegression</span><span class="p">):</span>

<div class="viewcode-block" id="ITLubberLogisticRegression.__init__"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ITLubberLogisticRegression.__init__">[文档]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="s2">&quot;l2&quot;</span><span class="p">,</span> <span class="n">calculate_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">intercept_scaling</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;lbfgs&quot;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">warm_start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ITLubberLogisticRegression，继承 sklearn.linear_model.LogisticRegression 方法，增加了统计性描述相关的内容输出，核心实现逻辑参考：https://github.com/ing-bank/skorecard/blob/main/skorecard/linear_model/linear_model.py#L11</span>

<span class="sd">        :param target: 数据集中标签名称，默认 target</span>
<span class="sd">        :param calculate_stats: 是否在训练模型时记录模型统计信息，默认 True，可以通过 summary 方法输出相关统计信息</span>
<span class="sd">        :param tol: 停止求解的标准，float类型，默认为1e-4</span>
<span class="sd">        :param C: 正则化系数λ的倒数，float类型，默认为1.0，必须是正浮点型数，值越小惩罚越大</span>
<span class="sd">        :param fit_intercept: 是否存在截距或偏差，bool类型，默认为True</span>
<span class="sd">        :param class_weight: 类型权重参数，默认 None，支持传入 dict or balanced，当设置 balanced 时，权重计算方式：n_samples / (n_classes * np.bincount(y))</span>
<span class="sd">        :param solver: 求解器设置，默认 lbfgs。对于小型数据集来说，选择 liblinear 更好；对于大型数据集来说，saga 或者 sag 会更快一些。对于多类问题我们只能使用 newton-cg、sag、saga、lbfgs。对于正则化来说，newton-cg、lbfgs 和 sag 只能用于L2正则化(因为这些优化算法都需要损失函数的一阶或者二阶连续导数， 因此无法用于没有连续导数的L1正则化)；而 liblinear，saga 则可处理L1正则化。newton-cg 是牛顿家族中的共轭梯度法，lbfgs 是一种拟牛顿法，sag 则是随机平均梯度下降法，saga 是随机优化算法，liblinear 是坐标轴下降法。</span>
<span class="sd">        :param penalty: 惩罚项，默认 l2，可选 l1、l2，solver 为 newton-cg、sag 和 lbfgs 时只支持L2，L1假设的是模型的参数满足拉普拉斯分布，L2假设的模型参数满足高斯分布</span>
<span class="sd">        :param intercept_scaling: 仅在 solver 选择 liblinear 并且 fit_intercept 设置为 True 的时候才有用</span>
<span class="sd">        :param dual: 对偶或原始方法，bool类型，默认为False，对偶方法只用在求解线性多核(liblinear)的L2惩罚项上。当样本数量&gt;样本特征的时候，dual通常设置为False</span>
<span class="sd">        :param random_state: 随机数种子，int类型，可选参数，默认为无，仅在 solver 为 sag 和 liblinear 时有用</span>
<span class="sd">        :param max_iter: 算法收敛最大迭代次数，int类型，默认 100。只在 solver 为 newton-cg、sag 和 lbfgs 时有用</span>
<span class="sd">        :param multi_class: 分类方法参数选择，默认 auto，可选 ovr、multinomial，如果分类问题是二分类问题，那么这两个参数的效果是一样的，主要体现在多分类问题上</span>
<span class="sd">        :param verbose: 日志级别，当 solver 为 liblinear、lbfgs 时设置为任意正数显示详细计算过程</span>
<span class="sd">        :param warm_start: 热启动参数，bool类型，表示是否使用上次的模型结果作为初始化，默认为 False</span>
<span class="sd">        :param n_jobs: 并行运算数量，默认为1，如果设置为-1，则表示将电脑的cpu全部用上</span>
<span class="sd">        :param l1_ratio: 弹性网络参数，其中0 &lt;= l1_ratio &lt;=1，仅当 penalty 为 elasticnet 时有效</span>

<span class="sd">        **参考样例**</span>

<span class="sd">        &gt;&gt;&gt; feature_pipeline = Pipeline([</span>
<span class="sd">        &gt;&gt;&gt;     (&quot;preprocessing_select&quot;, FeatureSelection(target=target, engine=&quot;scorecardpy&quot;)),</span>
<span class="sd">        &gt;&gt;&gt;     (&quot;combiner&quot;, Combiner(target=target, min_samples=0.2)),</span>
<span class="sd">        &gt;&gt;&gt;     (&quot;transform&quot;, WOETransformer(target=target)),</span>
<span class="sd">        &gt;&gt;&gt;     (&quot;processing_select&quot;, FeatureSelection(target=target, engine=&quot;scorecardpy&quot;)),</span>
<span class="sd">        &gt;&gt;&gt;     (&quot;stepwise&quot;, StepwiseSelection(target=target)),</span>
<span class="sd">        &gt;&gt;&gt;     # (&quot;logistic&quot;, LogisticClassifier(target=target)),</span>
<span class="sd">        &gt;&gt;&gt;     (&quot;logistic&quot;, ITLubberLogisticRegression(target=target)),</span>
<span class="sd">        &gt;&gt;&gt; ])</span>
<span class="sd">        &gt;&gt;&gt; feature_pipeline.fit(train)</span>
<span class="sd">        &gt;&gt;&gt; summary = feature_pipeline.named_steps[&#39;logistic&#39;].summary()</span>
<span class="sd">        &gt;&gt;&gt; summary</span>
<span class="sd">                                                            Coef.  Std.Err       z  P&gt;|z|  [ 0.025  0.975 ]    VIF</span>
<span class="sd">        const                                               -0.8511   0.0991 -8.5920 0.0000  -1.0452  -0.6569 1.0600</span>
<span class="sd">        credit_history                                       0.8594   0.1912  4.4954 0.0000   0.4847   1.2341 1.0794</span>
<span class="sd">        age_in_years                                         0.6176   0.2936  2.1032 0.0354   0.0421   1.1932 1.0955</span>
<span class="sd">        savings_account_and_bonds                            0.8842   0.2408  3.6717 0.0002   0.4122   1.3563 1.0331</span>
<span class="sd">        credit_amount                                        0.7027   0.2530  2.7771 0.0055   0.2068   1.1987 1.1587</span>
<span class="sd">        status_of_existing_checking_account                  0.6891   0.1607  4.2870 0.0000   0.3740   1.0042 1.0842</span>
<span class="sd">        personal_status_and_sex                              0.8785   0.5051  1.7391 0.0820  -0.1116   1.8685 1.0113</span>
<span class="sd">        purpose                                              1.1370   0.2328  4.8844 0.0000   0.6807   1.5932 1.0282</span>
<span class="sd">        present_employment_since                             0.7746   0.3247  2.3855 0.0171   0.1382   1.4110 1.0891</span>
<span class="sd">        installment_rate_in_percentage_of_disposable_income  1.3785   0.3434  4.0144 0.0001   0.7055   2.0515 1.0300</span>
<span class="sd">        duration_in_month                                    0.9310   0.1986  4.6876 0.0000   0.5417   1.3202 1.1636</span>
<span class="sd">        other_installment_plans                              0.8521   0.3459  2.4637 0.0138   0.1742   1.5301 1.0117</span>
<span class="sd">        housing                                              0.8251   0.4346  1.8983 0.0577  -0.0268   1.6770 1.0205</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="n">penalty</span><span class="p">,</span> <span class="n">dual</span><span class="o">=</span><span class="n">dual</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span><span class="n">fit_intercept</span><span class="p">,</span> <span class="n">intercept_scaling</span><span class="o">=</span><span class="n">intercept_scaling</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="n">class_weight</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="n">multi_class</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">warm_start</span><span class="o">=</span><span class="n">warm_start</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_ratio</span><span class="p">,</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_stats</span> <span class="o">=</span> <span class="n">calculate_stats</span></div>

<div class="viewcode-block" id="ITLubberLogisticRegression.fit"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ITLubberLogisticRegression.fit">[文档]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;逻辑回归训练方法</span>

<span class="sd">        :param x: 训练数据集，需包含目标变量</span>
<span class="sd">        :param sample_weight: 样本权重，参考：https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LogisticRegression.html#sklearn.linear_model.LogisticRegression.fit</span>
<span class="sd">        :param kwargs: 其他逻辑回归模型训练参数</span>
<span class="sd">        :return: ITLubberLogisticRegression，训练完成的逻辑回归模型</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_stats</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_sparse_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">names_</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;const&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">names_</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;const&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="n">lr</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">predProbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Design matrix -- add column of 1&#39;s at the beginning of your x matrix</span>
        <span class="k">if</span> <span class="n">lr</span><span class="o">.</span><span class="n">fit_intercept</span><span class="p">:</span>
            <span class="n">x_design</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">x</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_design</span> <span class="o">=</span> <span class="n">x</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vif</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">x_design</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_design</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">predProbs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">((</span><span class="n">x_design</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">x_design</span><span class="p">)</span>
        <span class="n">std_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix_</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># In case fit_intercept is set to True, then in the std_error array</span>
        <span class="c1"># Index 0 corresponds to the intercept, from index 1 onwards it relates to the coefficients</span>
        <span class="c1"># If fit intercept is False, then all the values are related to the coefficients</span>
        <span class="k">if</span> <span class="n">lr</span><span class="o">.</span><span class="n">fit_intercept</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">std_err_intercept_</span> <span class="o">=</span> <span class="n">std_err</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">std_err_coef_</span> <span class="o">=</span> <span class="n">std_err</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">z_intercept_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_err_intercept_</span>

            <span class="c1"># Get p-values under the gaussian assumption</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_val_intercept_</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_intercept_</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">std_err_intercept_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">std_err_coef_</span> <span class="o">=</span> <span class="n">std_err</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">z_intercept_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>

            <span class="c1"># Get p-values under the gaussian assumption</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_val_intercept_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">z_coef_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_err_coef_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_val_coef_</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_coef_</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ITLubberLogisticRegression.decision_function"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ITLubberLogisticRegression.decision_function">[文档]</a>    <span class="k">def</span> <span class="nf">decision_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;决策函数</span>

<span class="sd">        :param x: 需要预测的数据集，可以包含目标变量，会根据列名进行判断，如果包含会删除相关特征</span>
<span class="sd">        :return: np.ndarray，预测结果</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

        <span class="n">xp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_namespace</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">accept_sparse</span><span class="o">=</span><span class="s2">&quot;csr&quot;</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">safe_sparse_dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span>
        <span class="k">return</span> <span class="n">xp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span> <span class="k">if</span> <span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">scores</span></div>

<div class="viewcode-block" id="ITLubberLogisticRegression.corr"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ITLubberLogisticRegression.corr">[文档]</a>    <span class="k">def</span> <span class="nf">corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;数据集的特征相关性图</span>

<span class="sd">        :param data: 需要画特征相关性图的数据集</span>
<span class="sd">        :param save: 图片保存的地址，如果传入路径中有文件夹不存在，会新建相关文件夹，默认 None</span>
<span class="sd">        :param annot: 是否在图中显示相关性的数值，默认 True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">corr_plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">]),</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="n">annot</span><span class="p">)</span></div>

<div class="viewcode-block" id="ITLubberLogisticRegression.report"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ITLubberLogisticRegression.report">[文档]</a>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;逻辑回归模型报告</span>

<span class="sd">        :param data: 需要评估的数据集</span>
<span class="sd">        :return: pd.DataFrame，模型报告，包含准确率、F1等指标，参考：https://scikit-learn.org/stable/modules/generated/sklearn.metrics.classification_report.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">report_dict</span> <span class="o">=</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)),</span> <span class="n">output_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;好客户&quot;</span><span class="p">,</span> <span class="s2">&quot;坏客户&quot;</span><span class="p">])</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">report_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
        <span class="n">_report</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">report_dict</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;desc&quot;</span><span class="p">})</span>
        <span class="n">_report</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">_report</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">_report</span></div>

<div class="viewcode-block" id="ITLubberLogisticRegression.summary"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ITLubberLogisticRegression.summary">[文档]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: pd.DataFrame，逻辑回归模型统计信息</span>

<span class="sd">        - `Coef.`: 逻辑回归入模特征系数</span>
<span class="sd">        - `Std.Err`: 标准误差</span>
<span class="sd">        - `z`: Z检验统计量</span>
<span class="sd">        - `P&gt;|z|`: P值</span>
<span class="sd">        - `[ 0.025`: 置信区间下界</span>
<span class="sd">        - `0.975 ]`: 置信区间上界</span>
<span class="sd">        - `VIF`: 膨胀方差因子</span>

<span class="sd">        **参考样例**</span>

<span class="sd">        &gt;&gt;&gt; summary = logistic.summary()</span>
<span class="sd">        &gt;&gt;&gt; summary</span>
<span class="sd">                                                            Coef.  Std.Err       z  P&gt;|z|  [ 0.025  0.975 ]    VIF</span>
<span class="sd">        const                                               -0.8511   0.0991 -8.5920 0.0000  -1.0452  -0.6569 1.0600</span>
<span class="sd">        credit_history                                       0.8594   0.1912  4.4954 0.0000   0.4847   1.2341 1.0794</span>
<span class="sd">        age_in_years                                         0.6176   0.2936  2.1032 0.0354   0.0421   1.1932 1.0955</span>
<span class="sd">        savings_account_and_bonds                            0.8842   0.2408  3.6717 0.0002   0.4122   1.3563 1.0331</span>
<span class="sd">        credit_amount                                        0.7027   0.2530  2.7771 0.0055   0.2068   1.1987 1.1587</span>
<span class="sd">        status_of_existing_checking_account                  0.6891   0.1607  4.2870 0.0000   0.3740   1.0042 1.0842</span>
<span class="sd">        personal_status_and_sex                              0.8785   0.5051  1.7391 0.0820  -0.1116   1.8685 1.0113</span>
<span class="sd">        purpose                                              1.1370   0.2328  4.8844 0.0000   0.6807   1.5932 1.0282</span>
<span class="sd">        present_employment_since                             0.7746   0.3247  2.3855 0.0171   0.1382   1.4110 1.0891</span>
<span class="sd">        installment_rate_in_percentage_of_disposable_income  1.3785   0.3434  4.0144 0.0001   0.7055   2.0515 1.0300</span>
<span class="sd">        duration_in_month                                    0.9310   0.1986  4.6876 0.0000   0.5417   1.3202 1.1636</span>
<span class="sd">        other_installment_plans                              0.8521   0.3459  2.4637 0.0138   0.1742   1.5301 1.0117</span>
<span class="sd">        housing                                              0.8251   0.4346  1.8983 0.0577  -0.0268   1.6770 1.0205</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;std_err_coef_&quot;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Summary statistics were not calculated on .fit(). Options to fix:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- Re-fit using .fit(X, y, calculate_stats=True)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- Re-inititialize using LogisticRegression(calculate_stats=True)&quot;</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Coef.&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="s2">&quot;Std.Err&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">std_err_intercept_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_err_coef_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span>
            <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_intercept_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_coef_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="s2">&quot;P&gt;|z|&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_val_intercept_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val_coef_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">}</span>

        <span class="n">stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">names_</span><span class="p">)</span>
        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;[ 0.025&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Coef.&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Std.Err&quot;</span><span class="p">]</span>
        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;0.975 ]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Coef.&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Std.Err&quot;</span><span class="p">]</span>

        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;VIF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vif</span>

        <span class="k">return</span> <span class="n">stats</span></div>

<div class="viewcode-block" id="ITLubberLogisticRegression.summary2"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ITLubberLogisticRegression.summary2">[文档]</a>    <span class="k">def</span> <span class="nf">summary2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_map</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;summary 的基础上，支持传入数据字典，输出带有特征释义的统计信息表</span>

<span class="sd">        :param feature_map: 数据字典，默认 {}</span>

<span class="sd">        :return: pd.DataFrame，逻辑回归模型统计信息</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;Features&quot;</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">feature_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s2">&quot;Describe&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Features&quot;</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">stats</span></div>

<div class="viewcode-block" id="ITLubberLogisticRegression.convert_sparse_matrix"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ITLubberLogisticRegression.convert_sparse_matrix">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_sparse_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;稀疏特征优化&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="ITLubberLogisticRegression.plot_weights"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ITLubberLogisticRegression.plot_weights">[文档]</a>    <span class="k">def</span> <span class="nf">plot_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;#2639E9&quot;</span><span class="p">,</span> <span class="s2">&quot;#F76E6C&quot;</span><span class="p">,</span> <span class="s2">&quot;#FE7715&quot;</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;逻辑回归模型系数误差图</span>

<span class="sd">        :param save: 图片保存的地址，如果传入路径中有文件夹不存在，会新建相关文件夹，默认 None</span>
<span class="sd">        :param figsize: 图片大小，默认 (15, 8)</span>
<span class="sd">        :param fontsize: 字体大小，默认 14</span>
<span class="sd">        :param color: 图片主题颜色，默认即可</span>

<span class="sd">        :return: Figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Coef.&quot;</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">index</span>
        <span class="n">lower_error</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Coef.&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;[ 0.025&quot;</span><span class="p">]</span>
        <span class="n">upper_error</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;0.975 ]&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Coef.&quot;</span><span class="p">]</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="p">[</span><span class="n">lower_error</span><span class="p">,</span> <span class="n">upper_error</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">capthick</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mec</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># ax.tick_params(axis=&#39;x&#39;, labelrotation=0, grid_color=&quot;#FFFFFF&quot;, labelsize=fontsize)</span>
        <span class="c1"># ax.tick_params(axis=&#39;y&#39;, labelrotation=0, grid_color=&quot;#FFFFFF&quot;, labelsize=fontsize)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Regression Meta Analysis - Weight Plot</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Weight Estimates&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="ScoreCard"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard">[文档]</a><span class="k">class</span> <span class="nc">ScoreCard</span><span class="p">(</span><span class="n">toad</span><span class="o">.</span><span class="n">ScoreCard</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>

<div class="viewcode-block" id="ScoreCard.__init__"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.__init__">[文档]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">pdo</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">base_odds</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">base_score</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span> <span class="n">combiner</span><span class="o">=</span><span class="p">{},</span> <span class="n">transer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pretrain_lr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;评分卡模型</span>

<span class="sd">        :param target: 数据集中标签名称，默认 target</span>
<span class="sd">        :param pdo: odds 每增加 rate 倍时减少 pdo 分，默认 60</span>
<span class="sd">        :param rate: 倍率</span>
<span class="sd">        :param base_odds: 基础 odds，通常根据业务经验设置的基础比率（违约概率/正常概率），估算方法：（1-样本坏客户占比）/坏客户占比，默认 35，即 35:1 =&gt; 0.972 =&gt; 坏样本率 2.8%</span>
<span class="sd">        :param base_score: 基础 odds 对应的分数，默认 750</span>
<span class="sd">        :param combiner: 分箱转换器，传入 pipeline 时可以为None</span>
<span class="sd">        :param transer: woe转换器，传入 pipeline 时可以为None</span>
<span class="sd">        :param pretrain_lr: 预训练好的逻辑回归模型，可以不传</span>
<span class="sd">        :param pipeline: 训练好的 pipeline，必须包含 Combiner 和 WOETransformer</span>
<span class="sd">        :param kwargs: 其他相关参数，具体参考 toad.ScoreCard</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pipeline</span><span class="p">:</span>
            <span class="n">combiner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_steps</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">Combiner</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">transer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_steps</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">WOETransformer</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_steps</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="p">(</span><span class="n">ITLubberLogisticRegression</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">)):</span>
                <span class="n">pretrain_lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_steps</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="p">(</span><span class="n">ITLubberLogisticRegression</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">combiner</span><span class="o">=</span><span class="n">combiner</span><span class="o">.</span><span class="n">combiner</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combiner</span><span class="p">,</span> <span class="n">Combiner</span><span class="p">)</span> <span class="k">else</span> <span class="n">combiner</span><span class="p">,</span> <span class="n">transer</span><span class="o">=</span><span class="n">transer</span><span class="o">.</span><span class="n">transformer</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transer</span><span class="p">,</span> <span class="n">WOETransformer</span><span class="p">)</span> <span class="k">else</span> <span class="n">transer</span><span class="p">,</span>
            <span class="n">pdo</span><span class="o">=</span><span class="n">pdo</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span> <span class="n">base_odds</span><span class="o">=</span><span class="n">base_odds</span><span class="p">,</span> <span class="n">base_score</span><span class="o">=</span><span class="n">base_score</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretrain_lr</span> <span class="o">=</span> <span class="n">pretrain_lr</span></div>

<div class="viewcode-block" id="ScoreCard.fit"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.fit">[文档]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;评分卡模型训练方法</span>

<span class="sd">        :param x: 转换为 WOE 后的训练数据，需包含目标变量</span>

<span class="sd">        :return: ScoreCard，训练好的评分卡模型</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrain_lr</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pretrain_lr</span><span class="o">.</span><span class="n">feature_names_in_</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_feature_names</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transer</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;column </span><span class="se">\&#39;</span><span class="si">{f}</span><span class="se">\&#39;</span><span class="s1"> is not in transer&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrain_lr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrain_lr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_rules</span><span class="p">()</span>

        <span class="n">sub_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">woe_to_score</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_effect</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sub_score</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features_</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ScoreCard.transform"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.transform">[文档]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;评分转换方法</span>

<span class="sd">        :param x: 需要预测模型评分的原始数据，非 woe 转换后的数据</span>

<span class="sd">        :return: 预测的评分分数</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_check_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combiner</span><span class="p">,</span> <span class="n">transer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;评分卡特征分箱校验方法</span>

<span class="sd">        :param combiner: 特征分箱器</span>
<span class="sd">        :param transer: WOE转换器</span>
<span class="sd">        :return: bool，是否通过检验</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">combiner</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;column </span><span class="se">\&#39;</span><span class="si">{col}</span><span class="se">\&#39;</span><span class="s1"> is not in combiner&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transer</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;column </span><span class="se">\&#39;</span><span class="si">{col}</span><span class="se">\&#39;</span><span class="s1"> is not in transer&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">))</span>

            <span class="n">l_c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combiner</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="n">l_t</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">transer</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s1">&#39;woe&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">l_c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">combiner</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">l_c</span> <span class="o">!=</span> <span class="n">l_t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">combiner</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">combiner</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="n">combiner</span><span class="p">[</span><span class="n">col</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;column </span><span class="se">\&#39;</span><span class="si">{col}</span><span class="se">\&#39;</span><span class="s1"> is not matched, assert </span><span class="si">{l_t}</span><span class="s1"> bins but given </span><span class="si">{l_c}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">l_t</span><span class="o">=</span><span class="n">l_t</span><span class="p">,</span> <span class="n">l_c</span><span class="o">=</span><span class="n">l_c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">l_c</span> <span class="o">!=</span> <span class="n">l_t</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">r</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">)])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">combiner</span><span class="p">[</span><span class="n">col</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">combiner</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="s2">&quot;nan&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="k">else</span> <span class="n">b</span><span class="p">)</span>  <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">combiner</span><span class="p">[</span><span class="n">col</span><span class="p">]]})</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_check_rules</span><span class="p">(</span><span class="n">combiner</span><span class="p">,</span> <span class="n">transer</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;column </span><span class="se">\&#39;</span><span class="si">{col}</span><span class="se">\&#39;</span><span class="s1"> is not matched, assert </span><span class="si">{l_t}</span><span class="s1"> bins but given </span><span class="si">{l_c}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">l_t</span><span class="o">=</span><span class="n">l_t</span><span class="p">,</span> <span class="n">l_c</span><span class="o">=</span><span class="n">l_c</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="ScoreCard.score_clip"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.score_clip">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">score_clip</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;传入评分分数，根据评分分布情况，返回评分等距分箱规则</span>

<span class="sd">        :param score: 评分数据</span>
<span class="sd">        :param clip: 区间间隔</span>

<span class="sd">        :return: list，评分分箱规则</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clip_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">score</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="n">clip</span><span class="p">)</span> <span class="o">*</span> <span class="n">clip</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">score</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">/</span> <span class="n">clip</span><span class="p">)</span> <span class="o">*</span> <span class="n">clip</span><span class="p">)</span>
        <span class="n">clip_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">score</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">clip</span><span class="p">)</span> <span class="o">*</span> <span class="n">clip</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">score</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.99</span><span class="p">)</span> <span class="o">/</span> <span class="n">clip</span><span class="p">)</span> <span class="o">*</span> <span class="n">clip</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clip_start</span><span class="p">,</span> <span class="n">clip_end</span><span class="p">,</span> <span class="n">clip</span><span class="p">)]</span></div>

<div class="viewcode-block" id="ScoreCard.scorecard_scale"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.scorecard_scale">[文档]</a>    <span class="k">def</span> <span class="nf">scorecard_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;输出评分卡基准信息，包含 base_odds、base_score、rate、pdo、A、B</span>

<span class="sd">        :return: pd.DataFrame，评分卡基准信息</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scorecard_kedu</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="s2">&quot;base_odds&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_odds</span><span class="p">,</span> <span class="s2">&quot;根据业务经验设置的基础比率（违约概率/正常概率），估算方法：（1-样本坏客户占比）/坏客户占比&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;base_score&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_score</span><span class="p">,</span> <span class="s2">&quot;基础ODDS对应的分数&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="s2">&quot;设置分数的倍率&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;pdo&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdo</span><span class="p">,</span> <span class="s2">&quot;表示分数增长PDO时，ODDS值增长到RATE倍&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">,</span> <span class="s2">&quot;补偿值，计算方式：pdo / ln(rate)&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="s2">&quot;刻度，计算方式：base_score - B * ln(base_odds)&quot;</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;刻度项&quot;</span><span class="p">,</span> <span class="s2">&quot;刻度值&quot;</span><span class="p">,</span> <span class="s2">&quot;备注&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">scorecard_kedu</span></div>

<div class="viewcode-block" id="ScoreCard.format_bins"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.format_bins">[文档]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">format_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ellipsis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;分箱转换为标签</span>

<span class="sd">        :param bins: 分箱</span>
<span class="sd">        :param index: 是否需要索引</span>
<span class="sd">        :param ellipsis: 字符显示最大长度</span>

<span class="sd">        :return: ndarray: 分箱标签</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;全部样本&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">EMPTYBINS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="n">has_empty</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">has_empty</span><span class="p">:</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sp_l</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;负无穷&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">round_float</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="n">decimal</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bins</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;正无穷&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sp_l</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span> <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sp_l</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; , &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sp_l</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_empty</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;缺失值&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">bins</span><span class="p">:</span>
                <span class="n">keys_update</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;nan&quot;</span><span class="p">:</span>
                        <span class="n">keys_update</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;缺失值&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">keys_update</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;空字符串&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">keys_update</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keys_update</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ellipsis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">[:</span><span class="n">ellipsis</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;..&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ellipsis</span> <span class="k">else</span> <span class="n">label</span>

                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:02}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="s1">&#39;缺失值&#39;</span> <span class="k">else</span> <span class="n">EMPTYBINS</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l</span><span class="p">)</span></div>

<div class="viewcode-block" id="ScoreCard.scorecard_points"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.scorecard_points">[文档]</a>    <span class="k">def</span> <span class="nf">scorecard_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_map</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;输出评分卡分箱信息及其对应的分数</span>

<span class="sd">        :param feature_map: 数据字典，默认 {}，传入入模特征的数据字典，输出信息中将增加一列 变量含义</span>
<span class="sd">        :return: pd.DataFrame，评分卡分箱信息</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">card_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">to_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;变量名称&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;变量分箱&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="s2">&quot;对应分数&quot;</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">feature_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">card_points</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s2">&quot;变量含义&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">card_points</span><span class="p">[</span><span class="s2">&quot;变量名称&quot;</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">card_points</span></div>

<div class="viewcode-block" id="ScoreCard.scorecard2pmml"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.scorecard2pmml">[文档]</a>    <span class="k">def</span> <span class="nf">scorecard2pmml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pmml</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;scorecard.pmml&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;转换评分卡模型为本地 PMML 文件，使用本功能需要提前在环境中安装 jdk 1.8+ 以及 sklearn2pmml 库</span>

<span class="sd">        :param pmml: 保存 PMML 模型文件的路径</span>
<span class="sd">        :param debug: bool，是否开启调试模式，默认 False，当设置为 True 时，会返回评分卡 pipeline，同时显示转换细节</span>

<span class="sd">        :return: sklearn.pipeline.Pipeline，当设置 debug 为 True 时，返回评分卡 pipeline</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sklearn_pandas</span> <span class="kn">import</span> <span class="n">DataFrameMapper</span>
        <span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
        <span class="kn">from</span> <span class="nn">sklearn2pmml</span> <span class="kn">import</span> <span class="n">sklearn2pmml</span><span class="p">,</span> <span class="n">PMMLPipeline</span>
        <span class="kn">from</span> <span class="nn">sklearn2pmml.preprocessing</span> <span class="kn">import</span> <span class="n">LookupTransformer</span><span class="p">,</span> <span class="n">ExpressionTransformer</span>

        <span class="n">mapper</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">end_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">expression_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">total_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">default_value</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">bins</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">],</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
                    <span class="k">for</span> <span class="n">_bin</span> <span class="ow">in</span> <span class="n">bins</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">_bin</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_bin</span> <span class="o">==</span> <span class="s1">&#39;nan&#39;</span><span class="p">:</span>
                            <span class="n">default_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mapping</span><span class="p">[</span><span class="n">_bin</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

                <span class="n">mapper</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                    <span class="p">[</span><span class="n">var</span><span class="p">],</span>
                    <span class="n">LookupTransformer</span><span class="p">(</span><span class="n">mapping</span><span class="o">=</span><span class="n">mapping</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="n">default_value</span><span class="p">),</span>
                <span class="p">))</span>
                <span class="n">samples</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">),</span> <span class="mi">20</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">has_empty</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">has_empty</span><span class="p">:</span>
                    <span class="n">score_empty</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">total_bins</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">bin_scores</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">bin_vars</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">expression_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">score_empty</span><span class="si">}</span><span class="s1"> if pandas.isnull(X[0]) &#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bin_scores</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span>
                    <span class="n">bin_vars</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bin_scores</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">_expression_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bin_scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">total_bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">_expression_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; if X[0] &lt; </span><span class="si">{</span><span class="n">bin_vars</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> else </span><span class="si">{</span><span class="n">bin_scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_expression_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; if X[0] &lt; </span><span class="si">{</span><span class="n">bin_vars</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> else (</span><span class="si">{</span><span class="n">bin_scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> &#39;</span>
                        <span class="n">end_string</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

                <span class="n">_expression_string</span> <span class="o">+=</span> <span class="n">end_string</span>

                <span class="k">if</span> <span class="n">has_empty</span><span class="p">:</span>
                    <span class="n">expression_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;else (</span><span class="si">{</span><span class="n">_expression_string</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">_expression_string</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;else&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">_expression_string</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expression_string</span> <span class="o">+=</span> <span class="n">_expression_string</span>

                <span class="n">mapper</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                    <span class="p">[</span><span class="n">var</span><span class="p">],</span>
                    <span class="n">ExpressionTransformer</span><span class="p">(</span><span class="n">expression_string</span><span class="p">),</span>
                <span class="p">))</span>
                <span class="n">samples</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="n">scorecard_mapper</span> <span class="o">=</span> <span class="n">DataFrameMapper</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">df_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">PMMLPipeline</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;preprocessing&#39;</span><span class="p">,</span> <span class="n">scorecard_mapper</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;scorecard&#39;</span><span class="p">,</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
        <span class="p">])</span>

        <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;score&#39;</span><span class="p">))</span>

        <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;scorecard&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scorecard_mapper</span><span class="o">.</span><span class="n">features</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sklearn2pmml</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">pmml</span><span class="p">,</span> <span class="n">with_repr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">pipeline</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pipeline</span></div>

<div class="viewcode-block" id="ScoreCard.KS_bucket"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.KS_bucket">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">KS_bucket</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;用于评估评分卡排序性的方法</span>

<span class="sd">        :param y_pred: 模型预测结果，传入评分卡预测的评分或LR预测的概率</span>
<span class="sd">        :param y_true: 样本好坏标签</span>
<span class="sd">        :param bucket: 分箱数量，默认 10</span>
<span class="sd">        :param method: 分箱方法，支持 chi、dt、quantile、step、kmeans，默认 quantile</span>

<span class="sd">        :return: 评分卡分箱后的统计信息，推荐直接使用 feature_bin_stats 方法</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">toad</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">KS_bucket</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span></div>

<div class="viewcode-block" id="ScoreCard.KS"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.KS">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">KS</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;计算 KS 指标</span>

<span class="sd">        :param y_pred: 模型预测结果，传入评分卡预测的评分或LR预测的概率</span>
<span class="sd">        :param y_true: 样本好坏标签</span>

<span class="sd">        :return: float，KS 指标</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">toad</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">KS</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">)</span></div>

<div class="viewcode-block" id="ScoreCard.AUC"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.AUC">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">AUC</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;计算 AUC 指标</span>

<span class="sd">        :param y_pred: 模型预测结果，传入评分卡预测的评分或LR预测的概率</span>
<span class="sd">        :param y_true: 样本好坏标签</span>

<span class="sd">        :return: float，AUC 指标</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">toad</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">AUC</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">)</span></div>

<div class="viewcode-block" id="ScoreCard.perf_eva"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.perf_eva">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">perf_eva</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ks&quot;</span><span class="p">,</span> <span class="s2">&quot;roc&quot;</span><span class="p">],</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;评分卡效果评估方法</span>

<span class="sd">        :param y_pred: 模型预测结果，传入评分卡预测的评分或LR预测的概率</span>
<span class="sd">        :param y_true: 样本好坏标签</span>
<span class="sd">        :param title: 图像标题</span>
<span class="sd">        :param plot_type: 画图的类型，可选 ks、auc、lift、pr</span>
<span class="sd">        :param save: 图片保存的地址，如果传入路径中有文件夹不存在，会新建相关文件夹，默认 None</span>
<span class="sd">        :param figsize: 图像尺寸大小，传入一个tuple，默认 （14， 6）</span>

<span class="sd">        :return: dict，包含 ks、auc、gini、figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># plt.figure(figsize=figsize)</span>
        <span class="n">rt</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">perf_eva</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save</span><span class="p">))</span>

            <span class="n">rt</span><span class="p">[</span><span class="s2">&quot;pic&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rt</span></div>

<div class="viewcode-block" id="ScoreCard.ks_plot"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.ks_plot">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ks_plot</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;数值特征 KS曲线 &amp; ROC曲线</span>
<span class="sd">        </span>
<span class="sd">        :param score: 数值特征，通常为评分卡分数</span>
<span class="sd">        :param y_true: 标签值</span>
<span class="sd">        :param title: 图像标题</span>
<span class="sd">        :param fontsize: 字体大小，默认 14</span>
<span class="sd">        :param figsize: 图像大小，默认 (16, 8)</span>
<span class="sd">        :param save: 图片保存的地址，如果传入路径中有文件夹不存在，会新建相关文件夹，默认 None</span>
<span class="sd">        :param kwargs: 其他参数，参考：scorecardpipeline.utils.hist_plot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ks_plot</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ScoreCard.PSI"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.PSI">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">PSI</span><span class="p">(</span><span class="n">y_pred_train</span><span class="p">,</span> <span class="n">y_pred_oot</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;计算两个数据集评分或预测结果的 PSI</span>

<span class="sd">        :param y_pred_train: 基准数据集的数值特征，通常为评分卡分数</span>
<span class="sd">        :param y_pred_oot: 对照数据集的数值特征</span>
<span class="sd">        :return: float，PSI 指标值</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">toad</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">PSI</span><span class="p">(</span><span class="n">y_pred_train</span><span class="p">,</span> <span class="n">y_pred_oot</span><span class="p">)</span></div>

<div class="viewcode-block" id="ScoreCard.perf_psi"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.perf_psi">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">perf_psi</span><span class="p">(</span><span class="n">y_pred_train</span><span class="p">,</span> <span class="n">y_pred_oot</span><span class="p">,</span> <span class="n">y_true_train</span><span class="p">,</span> <span class="n">y_true_oot</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">],</span> <span class="n">x_limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_tick_break</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_distr_dat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;scorecardpy 的 perf_psi 方法，基于两个数据集的画 PSI 图</span>

<span class="sd">        :param y_pred_train: 基准数据集的数值特征，通常为评分卡分数</span>
<span class="sd">        :param y_pred_oot: 对照数据集的数值特征</span>
<span class="sd">        :param y_true_train: 基准数据集的真实标签</span>
<span class="sd">        :param y_true_oot: 基准数据集的真实标签</span>
<span class="sd">        :param keys: 基准数据集和对照数据集的名称</span>
<span class="sd">        :param x_limits: x 轴的区间，默认为 None</span>
<span class="sd">        :param x_tick_break: 评分区间步长</span>
<span class="sd">        :param show_plot: 是否显示图像，默认 True</span>
<span class="sd">        :param return_distr_dat: 是否返回分布数据</span>

<span class="sd">        :return: dict，PSI 指标 &amp; 图片</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sc</span><span class="o">.</span><span class="n">perf_psi</span><span class="p">(</span>
            <span class="n">score</span><span class="o">=</span><span class="p">{</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">y_pred_train</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">y_pred_oot</span><span class="p">},</span>
            <span class="n">label</span><span class="o">=</span><span class="p">{</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">y_true_train</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">y_true_oot</span><span class="p">},</span>
            <span class="n">x_limits</span><span class="o">=</span><span class="n">x_limits</span><span class="p">,</span>
            <span class="n">x_tick_break</span><span class="o">=</span><span class="n">x_tick_break</span><span class="p">,</span>
            <span class="n">show_plot</span><span class="o">=</span><span class="n">show_plot</span><span class="p">,</span>
            <span class="n">return_distr_dat</span><span class="o">=</span><span class="n">return_distr_dat</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ScoreCard.score_hist"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.score_hist">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">score_hist</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;数值特征分布图</span>

<span class="sd">        :param score: 数值特征，通常为评分卡分数</span>
<span class="sd">        :param y_true: 标签值</span>
<span class="sd">        :param figsize: 图像大小，默认 (15, 10)</span>
<span class="sd">        :param bins: 分箱数量大小，默认 30</span>
<span class="sd">        :param save: 图片保存的地址，如果传入路径中有文件夹不存在，会新建相关文件夹，默认 None</span>
<span class="sd">        :param kwargs: scorecardpipeline.utils.hist_plot 方法的其他参数</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hist_plot</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_format_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;分箱区间精度调整</span>

<span class="sd">        :param rule: 分箱信息</span>
<span class="sd">        :param decimal: 精度</span>
<span class="sd">        :return: dict，评分卡分箱及分数</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_bins</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">])</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="n">decimal</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">scores</span><span class="p">))</span>

<div class="viewcode-block" id="ScoreCard.class_steps"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.class_steps">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">class_steps</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;根据 query 查询 pipeline 中对应的 step</span>

<span class="sd">        :param pipeline: sklearn.pipeline.Pipeline，训练后的数据预处理 pipeline</span>
<span class="sd">        :param query: 需要查询的类，可以从 pipeline 中查找 WOETransformer 和 Combiner</span>

<span class="sd">        :return: list，对应的组件</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">query</span><span class="p">)]</span></div>

<div class="viewcode-block" id="ScoreCard.feature_bin_stats"><a class="viewcode-back" href="../../scorecardpipeline.html#scorecardpipeline.ScoreCard.feature_bin_stats">[文档]</a>    <span class="k">def</span> <span class="nf">feature_bin_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">rules</span><span class="o">=</span><span class="p">{},</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="n">max_n_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;评分卡分数&quot;</span><span class="p">,</span> <span class="n">ks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;评估评分卡排序性的方法，可以输出各分数区间的各项指标</span>

<span class="sd">        :param data: 需要查看的数据集</span>
<span class="sd">        :param feature: 数值性特征名称，通常为预测的概率或评分卡分数</span>
<span class="sd">        :param rules: 自定义的区间划分规则</span>
<span class="sd">        :param method: 分箱方法</span>
<span class="sd">        :param max_n_bins: 最大分箱数</span>
<span class="sd">        :param desc: 特征描述</span>
<span class="sd">        :param ks: 是否统计 KS 指标并输出相关统计信息</span>
<span class="sd">        :param kwargs: Combiner.feature_bin_stats 方法的其他参数</span>

<span class="sd">        :return: pd.DataFrame，评分各区间的统计信息</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Combiner</span><span class="o">.</span><span class="n">feature_bin_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">max_n_bins</span><span class="o">=</span><span class="n">max_n_bins</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">ks</span><span class="o">=</span><span class="n">ks</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>
</pre></div>
</article>
        
      </main>
    </div>

    <footer class="nftt-footer">
      
<nav id="paginator"></nav>

      <div class="py-5 px-4 px-md-3">
  <div class="container">
    
    <div class="row">
      <ul class="list-unstyled list-separator col-lg-12 pb-2 text-center">
        
          
          
          <li class="d-inline">
            <a href="https://itlubber.art" class="list-item">itlubber</a>
          </li>
        
          
          
          <li class="d-inline">
            <a href="https://github.com/itlubber/scorecardpipeline" class="list-item">github</a>
          </li>
        
          
          
          <li class="d-inline">
            <a href="https://github.com/itlubber/scorecardpipeline/blob/main/examples/scorecard_samples.ipynb" class="list-item">examples</a>
          </li>
        
      </ul>
    </div>
    

    <div class="row">
      <div class="col-lg-12 text-center">
        <a class="brand-text d-inline-flex align-items-center mb-2 text-decoration-none" href="/" aria-label="Nefertiti-for-Sphinx">
          <span class="fs-6 fw-bold">scorecardpipeline</span>
        </a>
        
          <ul class="list-unstyled small text-muted">
            <li>2023, itlubber</li>
          </ul>
        
        
      </div>
    </div>
  </div>
</div>
    </footer>
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/translations.js"></script>
    <script src="../../_static/design-tabs.js"></script>

    <script type="text/javascript" src="../../_static/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="../../_static/sphinx-nefertiti.min.js"></script>
    
  </body>
</html>